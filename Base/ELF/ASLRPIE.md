# ASLR和PIE的随机化及关系

Linux 平台上 ASLR(Address space layout  randomization:地址空间布局随机化) 分为 0，1，2 三级，用户可以通过一个内核参数 randomize_va_space 进行等级控制。它们对应的效果如下：

> 0：没有随机化。即关闭 ASLR。  
> 1：保留的随机化。共享库、栈、mmap() 以及 VDSO 将被随机化。  
> 2：完全的随机化。在 1 的基础上，通过 brk() 分配的内存空间也将被随机化。

**ASLR 并不负责代码段和数据段的随机化工作。事实上，Linux 平台通过 PIE机制来负责代码段和数据段的随机化工作，而不是 ASLR。要开启 PIE，在使用gcc进行编译链接时添加 -fpie -pie 选项即可** 

**ASLR 不负责代码段以及数据段的随机化工作，这项工作由 PIE 负责。但是只有在开启ASLR之后，PIE才会生效**

**在 Linux 平台上，堆空间的分配是通过 mmap() 以及 brk() 这两个系统调用完成的。在上面分级效果可以看到，当等级为 1 时，通过 mmap() 分配的堆空间将被随机化，但并不包括 brk() 分配的堆空间。在等级为 2 时，通过 brk() 分配的内存空间也将被随机化，即此时堆空间被完全随机化。**

**补充1**：PIE和PIC相同点与区别：
> PIC。Position-Independent Code，译为“位置无关代码”。在计算机系统中，PIC是可以在主存中不同位置执行的目标代码。  
> PIE。Position-Independent Executable，译为“位置无关可执行程序”。它是完全**由位置无关代码所组成**的可执行二进制文件，有时可称为PIC Executable。它有一个显著的优点，那就是当程序加载时，所有PIE二进制文件以及它所有的依赖都会加载到虚拟内存空间中的随机位置（随机地址），可以有效提高他人通过绝对地址实施"return-to-libc"安全攻击的难度。  

不同点：
PIC:用在库文件
PIE:用在可执行文件
共同点：
生成跟位置没有关系的symbol

简单理解：PIC用于库文件，PIE用于可执行文件。非PIE的可执行文件，代码段和数据段的虚拟地址固定;PIE可执行文件，代码段和数据段的虚拟地址随即化了。

**补充2**：共享库代码内部各个函数之间的偏移地址是固定。可以观察libc.so.6中对read函数的交叉引用，在交叉引用出，call/jmp read 指令都是通过偏移地址，这体现了PIC代码的位置无关特点，也表示函数之间的偏移地址必然固定。所以，可以通过泄露的libc.so.6来计算远程函数的地址。或者通过泄露的函数地址在[libcdb.com](http://libcdb.com)搜索，获取可能的libc版本。



